<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/style.css" />
  <title>JamJournal - Home</title>
</head>
<body>
  <%- include('partials/nav') %>

  <!-- ===== MAIN BODY ===== -->
  <main class="container my-4">
    <% if (user) { %>
      <!-- ADD SONG BUTTON -->
      <div class="row mb-4">
        <div class="col text-center">
          <button
            type="button"
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#addSongModal">
            Add Song +
          </button>

          <button
            type="button"
            class="btn btn-danger ms-2"
            data-bs-toggle="modal"
            data-bs-target="#deleteSongModal">
            Delete Song -
          </button>
        </div>
      </div>



      <!-- FRIENDS’ REVIEWS -->
      <section class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h4 mb-0">Friends' Reviews</h2>
        </div>

        <% if (friendsFeed && friendsFeed.length > 0) { %>
          <div class="row g-3">
            <% friendsFeed.forEach(function(r) { %>
              <div class="col-12 col-md-6">
                <article class="border rounded p-3 h-100 bg-white shadow-sm">
                  <div class="d-flex">
                    <img
                      src="<%= r.albumArt || '/images/placeholder-album.png' %>"
                      alt="Album art for <%= r.songTitle %>"
                      class="me-3 rounded"
                      width="80" height="80" />

                    <div class="flex-grow-1">
                      <!-- top line: username + time -->
                      <div class="d-flex justify-content-between align-items-start mb-1">
                        <small class="text-muted">
                          by <a href="/u/<%= r.friendUsername %>">@<%= r.friendUsername %></a>
                        </small>
                        <small class="text-muted">
                          <time datetime="<%= r.createdISO %>"><%= r.createdHuman %></time>
                        </small>
                      </div>

                      <!-- song + rating -->
                      <h5 class="mb-1"><%= r.songTitle %></h5>
                      <small class="text-muted d-block mb-2">
                        <%= r.artist %> • <%= r.rating %>/10
                      </small>

                      <!-- optional comment -->
                      <% if (r.comment) { %>
                        <p class="mb-0"><%= r.comment %></p>
                      <% } %>
                    </div>
                  </div>
                </article>
              </div>
            <% }); %>
          </div>
        <% } else { %>
          <p class="text-center text-muted mb-0">
            No recent activity from friends yet. Try following more users to see their reviews here!
          </p>
        <% } %>
      </section>

    <% } else { %>
      <!-- LOGGED-OUT HERO -->
      <div class="text-center my-5">
        <h1 class="fw-bold">Welcome to Jam Journal</h1>
        <p class="lead">We hope music enthusiasts and general music enjoyers can come together to rate songs, write reviews, 
          and discover new tracks. Add new friends and see what they're listening to. Here you can build a community solely based on
        our music tastes. Hope you enjoy!
        <br> <br> Don't have an account? </p>
        <a href="/auth/signup" class="btn btn-primary me-2">Sign Up</a>

          <br> <br>

        <p class="lead">Have an account?</p>
        <a href="/auth/login" class="btn btn-outline-secondary">Login</a>
        <div class="mt-4">
          <!-- <a href="/discover" class="btn btn-link">
            Or browse trending songs →
          </a> -->
        </div>
      </div>
    <% } %>
  </main>

  <!-- ===== ADD SONG MODAL (only for logged-in) ===== -->
  <% if (user) { %>
    <div class="modal fade" id="addSongModal" tabindex="-1"
         aria-labelledby="addSongModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="addSongModalLabel" class="modal-title">Add a New Song</h5>
            <button type="button" class="btn-close"
                    data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form action="/reviews" method="post" class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label">Title</label>
                <input name="title" class="form-control" required />
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Artist</label>
                <input name="artist" class="form-control" required />
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Genre</label>
                <input name="genre" class="form-control" />
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Rating (1–10)</label>
                <input type="number" name="rating"
                       min="1" max="10" class="form-control" required />
              </div>
              <div class="col-12">
                <label class="form-label">Comment</label>
                <textarea name="comment" rows="3" class="form-control"></textarea>
              </div>
              <div class="col-12 text-end">
                <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  <% } %>

  <% if (user) { %>
    <div class="modal fade" id="deleteSongModal" tabindex="-1"
        aria-labelledby="deleteSongModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="deleteSongModalLabel" class="modal-title">Delete a Song</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <% if (typeof myReviews !== 'undefined' && myReviews.length > 0) { %>

              <form action="/reviews/delete" method="post">
                <div class="mb-3">
                  <label class="form-label">Select a song to remove:</label>
                  <select name="reviewId" class="form-select" required>
                    <option value="" disabled selected>-- Choose a song --</option>
                    <% myReviews.forEach(function(review) { %>
                      <option value="<%= review.reviewId %>"><%= review.Title %> by <%= review.Artist %></option>
                    <% }); %>
                  </select>
                </div>

                <div class="alert alert-warning text-small">
                  This song will be gone you know ...
                </div>
                <div class="text-end">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-danger">Delete</button>
                </div>
              </form>

            <% } else { %>
              <p class="text-center text-muted">You haven't added any songs yet.</p>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  <% } %>

<%- include('partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/home.js" defer></script>
</body>
</html>
